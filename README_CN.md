# **DemoProject是ElevateSDK的演示项目**

## Unity版本使用的最新的2018.3.6f1（开发者可以使用自己的版本）

* 开发者需要添加下列文件夹到自己的项目中

    ![Image text](./ImgFolder/img_1.png)

* 由于Unity打包出现了很多版本不兼容的问题，建议将Unity项目导出到AndroidStudio中，如下图

    ![Image text](./ImgFolder/img_2.png)

* 项目结构如下:

    ![Image text](./ImgFolder/img_3.png)

* 下面的步骤很重要：
  
  * 打开项目后向下面代码中添加接口函数

    ![Image text](./ImgFolder/img_4.png)

    ``` bash
        // Return payment result
        @Override
        protected void onActivityResult(int requestCode, int resultCode, Intent data) {
            if (requestCode == PAY_REQUEST && resultCode == RESULT_OK){
                String tradelogNo = data.getStringExtra(TRADELOGS_NO);
                Log.d(TAG, "onActivityResult: " + tradelogNo);
                UnityPlayer.UnitySendMessage("ElevateObject","PurchaseResult", tradelogNo);
            }
        }

        // Unity interface.
        public void init(String appId, boolean isDev){
            SDKManager.init(this, appId, isDev);
        }

        public void purchase(String goodsNo, int count){
            try {
                Intent intent = new Intent(this, PaymentActivity.class);
                intent.putExtra(GOODS_NO, goodsNo);
                intent.putExtra(COUNT, count);
                startActivityForResult(intent, PAY_REQUEST);
            } catch (ActivityNotFoundException a) {
                Log.e(TAG, "Launch payment activity: " + a.getMessage());
            }
        }

        public void openLogin(){
            runOnUiThread(new Runnable() {
                @Override
                public void run() {
                    SDKManager.getInstance().openLogin();
                }
            });
        }

        public void getOrderInfo(final String tradelog){
            runOnUiThread(new Runnable() {
                @Override
                public void run() {
                    SDKManager.getInstance().getOrderInfo(tradelog);
                }
            });
        }

        public void queryByGoodsNo(final String goodsNo) {
            runOnUiThread(new Runnable() {
                @Override
                public void run() {
                    SDKManager.getInstance().queryByGoodsNo(goodsNo);
                }
            });
        }
    ```

  * 修改AndroidManifest.xml文件，在Aplication节点下添加如下代码

    ```bash
    <activity
        android:name="com.elevate.games.plugin.PaymentActivity"
        android:theme="@style/Theme.AppCompat.Light.NoActionBar">
      <intent-filter>
        <action android:name="android.intent.action.DEFAULT" />
        <category android:name="android.intent.category.DEFAULT"/>
      </intent-filter>
    </activity>

    <activity
        android:name="com.elevate.games.plugin.StripeActivity"
        android:theme="@style/Theme.AppCompat.Light.NoActionBar">
      <intent-filter>
        <action android:name="android.intent.action.DEFAULT" />
        <category android:name="android.intent.category.DEFAULT"/>
      </intent-filter>
    </activity>

    <activity
        android:name="com.elevate.games.plugin.WebActivity"
        android:theme="@style/Theme.AppCompat.Light.NoActionBar">
      <intent-filter>
        <action android:name="android.intent.action.DEFAULT" />
        <category android:name="android.intent.category.DEFAULT"/>
      </intent-filter>
    </activity>
    ```

  * 修改build.gradle文件，替换掉全部内容

    ```bash
    // GENERATED BY UNITY. REMOVE THIS COMMENT TO PREVENT OVERWRITING WHEN EXPORTING AGAIN

    buildscript {
        repositories {
            google()
            jcenter()
            maven { url "https://jitpack.io" }
        }

        dependencies {
            classpath 'com.android.tools.build:gradle:3.2.0'
            classpath 'org.greenrobot:greendao-gradle-plugin:3.2.2'
        }
    }

    allprojects {
        repositories {
            google()
            jcenter()
            flatDir {
                dirs 'libs'
                maven { url "https://jitpack.io" }
            }
        }
    }

    apply plugin: 'com.android.application'


    dependencies {
        implementation fileTree(dir: 'libs', include: ['*.jar'])

        implementation 'com.android.support:appcompat-v7:26.1.0'
        implementation 'com.android.support:design:26.1.0'
        implementation 'com.android.support.constraint:constraint-layout:1.1.3'
        implementation 'com.android.support:recyclerview-v7:26.1.0'
        implementation 'com.android.support:support-v4:26.1.0'
        /* WebTool */
        implementation 'com.just.agentweb:agentweb:4.0.2'
        /* TextTool */
        implementation 'me.codeboy.android:align-text-view:2.3.2'
        /* Needed for RxAndroid */
        implementation 'io.reactivex:rxandroid:1.2.1'
        implementation 'io.reactivex:rxjava:1.3.0'
        /* Needed for Rx Bindings on views */
        implementation 'com.jakewharton.rxbinding:rxbinding:1.0.1'
        /* Used for server calls */
        implementation 'com.squareup.okio:okio:2.2.1'
        implementation 'com.squareup.retrofit2:retrofit:2.5.0'
        /* Used to make Retrofit easier and GSON & Rx-compatible*/
        implementation 'com.google.code.gson:gson:2.8.5'
        implementation 'com.squareup.retrofit2:adapter-rxjava:2.3.0'
        implementation 'com.squareup.retrofit2:converter-gson:2.5.0'
        /* Used to debug your Retrofit connections */
        implementation 'com.squareup.okhttp3:logging-interceptor:3.12.1'
        /* HttpCookies */
        implementation 'com.github.franmontiel:PersistentCookieJar:v1.0.1'
        /* Stripe */
        implementation 'com.stripe:stripe-android:6.1.2'
        /*database */
        implementation 'org.greenrobot:greendao:3.2.2'
        implementation 'net.zetetic:android-database-sqlcipher:4.0.1'
        implementation 'de.hdodenhof:circleimageview:2.2.0'

        implementation(name: 'plugin', ext: 'aar')
    }

    android {
        compileSdkVersion 26

        defaultConfig {
            minSdkVersion 16
            targetSdkVersion 26
            applicationId 'com.multiverse.demo'
            ndk {
                abiFilters 'armeabi-v7a', 'x86'
            }
            versionCode 1
            versionName '0.1'
        }

        lintOptions {
            abortOnError false
        }

        aaptOptions {
            noCompress = ['.unity3d', '.ress', '.resource', '.obb']
        }

        buildTypes {
            debug {
                minifyEnabled false
                useProguard false
                proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-unity.txt'
                jniDebuggable true
            }
            release {
                minifyEnabled false
                useProguard false
                proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-unity.txt'
                signingConfig signingConfigs.debug
            }
        }

        packagingOptions {
            doNotStrip '*/armeabi-v7a/*.so'
            doNotStrip '*/x86/*.so'
        }

        bundle {
            language {
                enableSplit = false
            }
            density {
                enableSplit = false
            }
            abi {
                enableSplit = true
            }
        }
    }
    ```

  * 然后把其中的applicationId修改成自己的包名，然后将plugin.aar添加到libs文件夹中

    ![Image text](./ImgFolder/img_5.png)

* 最后点击编译

## Unity接口说明

* 默认调用SDK初始化，打开登录界面
  
    ```bash
    private void InitSDK(bool isDev);
    ```

* 打开登录界面重新登录

    ```bash
    public void OpenLogin();
    ```

* 内购接口，传入平台申请的商品ID和数量(非消耗商品数量为1)

    ```bash
    public void Purchase(string goodsNo, int count);
    ```

* 查询订单信息，通过支付完成的回调的字符串OrderNo作为参数

    ```bash
    public void GetOrderInfo(string orderNo);
    ```

* 通过商品ID查询是否买过这个商品

    ```bash
    public void QueryByGoodsNo(string goodsNo);
    ```